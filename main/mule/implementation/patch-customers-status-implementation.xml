<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:db="http://www.mulesoft.org/schema/mule/db" xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/db http://www.mulesoft.org/schema/mule/db/current/mule-db.xsd">
	<sub-flow name="patch-customers-status-implementation-sub-flow" doc:id="ad786835-cbcd-4cac-9d50-f4c97ecf1f94" >
		<logger level="INFO" doc:name="Start" doc:id="0c253cb8-6f88-4f08-a458-52c415536d7d" message='Start FLOW #[flow.name] "Bulk update customer status"-- #[now()]'/>
		<ee:transform doc:name="Request Payload" doc:id="0e81c7df-26f6-4816-8678-3f0cb15d50c2" >
			<ee:message >
				<ee:set-payload ><![CDATA[%dw 2.0
output application/json
---
payload map ((item, index) -> 
{
        "customerId": item.'customer_ID',
        "status": item.status,
        "lastModifiedDateTime": (now() as String {format : "dd-MM-yyyy'T'hh:mm:ss"})
	}
)]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<db:bulk-update doc:name="Bulk update customer status" doc:id="0d93debf-1b10-42b5-8436-7a3b14fb7d18" config-ref="Database_Config">
			<db:sql><![CDATA[UPDATE `customer` SET status = :status, lastModifiedDateTime = :lastModifiedDateTime WHERE customerId = :customerId;
]]></db:sql>
		</db:bulk-update>
		<ee:transform doc:name="Response Payload" doc:id="a2799408-e156-446c-812e-b76519afce71">
			<ee:message>
				<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
	"message": sizeOf(payload) ++ " " ++ "CustomerID Upadted"
}
]]></ee:set-payload>
			</ee:message>
		</ee:transform>
		<logger level="INFO" doc:name="End" doc:id="8da89136-61a8-4ce1-89da-2ae5599c5e26" message='END FLOW "Bulk update customer status" -- #[now()]'/>
		
	</sub-flow>
</mule>
